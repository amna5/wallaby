<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan</title>
    <link rel="stylesheet" href="inside.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="app">
      <div class="adjust">
        <div class="header">
          <img src="../img/arrow.svg" alt="arrow" id="backArrow" />
          <h1>Scan</h1>
        </div>
        <h3 class="scan-desc">scan barcode or food</h3>
        <div class="camera-container">
          <video id="camera-feed" autoplay playsinline></video>
        </div>
        <div class="floating-nav">
          <button class="nav-btn">
            <a href="home.html"
              ><img src="../img/home_button.svg" alt="Home"
            /></a>
          </button>

          <button class="nav-btn active">
            <a href="scanner.html"><img src="../img/scan.svg" alt="Scan" /></a>
          </button>

          <button class="nav-btn">
            <a href=""><img src="../img/people.svg" alt="Users" /></a>
          </button>
        </div>
      </div>
    </div>
    <!-- Demo controls (remove in production) -->
    <div class="demo-controls">
      <button
        class="demo-btn"
        onclick="
          showFoodPopup({
            name: 'Roti Canai',
            calorie: 2000,
            protein: 5,
            sugar: 2,
            sodium: 2,
            fat: 5,
            fiber: 10,
          })
        "
      >
        Demo: Food Popup
      </button>
      <button
        class="demo-btn"
        onclick="
          showBarcodePopup({
            name: 'Heinz Beans 200g',
            image: '../img/beans.png',
          })
        "
      >
        Demo: Barcode Popup
      </button>
    </div>

    <!-- Backdrop -->
    <div class="overlay-backdrop" id="backdrop"></div>

    <!-- =====================
         FOOD INFO POPUP
    ===================== -->
    <div
      class="bottom-sheet"
      id="food-popup"
      role="dialog"
      aria-modal="true"
      aria-label="Food details"
    >
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <h2 id="food-name">Food Name</h2>
        <button
          class="edit-btn"
          id="edit-toggle-btn"
          title="Edit nutrients"
          onclick="toggleEdit()"
        >
          <!-- Pencil icon -->
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
            />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>
      </div>

      <div class="nutrient-list">
        <div class="nutrient-row">
          <label>calorie</label>
          <input type="number" id="f-calorie" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>protein(g)</label>
          <input type="number" id="f-protein" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>sugar(g)</label>
          <input type="number" id="f-sugar" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>sodium(g)</label>
          <input type="number" id="f-sodium" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>fat(g)</label>
          <input type="number" id="f-fat" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>fiber(g)</label>
          <input type="number" id="f-fiber" value="0" readonly />
        </div>
      </div>

      <div class="sheet-actions">
        <button class="sheet-btn btn-cancel" onclick="closePopups()">
          Cancel
        </button>
        <button class="sheet-btn btn-add" onclick="addFoodEntry()">Add</button>
      </div>
    </div>

    <!-- =====================
         BARCODE POPUP
    ===================== -->
    <div
      class="bottom-sheet"
      id="barcode-popup"
      role="dialog"
      aria-modal="true"
      aria-label="Product details"
    >
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <h2 id="barcode-name">Product Name</h2>
      </div>

      <div style="padding-bottom: 80px" class="product-image-wrap">
        <img id="barcode-image" src="" alt="Product image" />
      </div>

      <div class="sheet-actions">
        <button class="sheet-btn btn-cancel" onclick="closePopups()">
          Cancel
        </button>
        <button class="sheet-btn btn-add" onclick="addBarcodeEntry()">
          Add
        </button>
      </div>
    </div>
    <script>
      document
        .getElementById("backArrow")
        .addEventListener("click", function () {
          // Check if there's a previous page in history
          if (document.referrer && document.referrer !== "") {
            // If there's a referrer (previous page), go back
            window.history.back();
          } else {
            // If no previous page, go to home
            window.location.href = "home.html";
          }
        });

      const video = document.getElementById("camera-feed");

      async function startCamera() {
        try {
          // Request camera access
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true, // Enable video
            audio: false, // Audio not needed for scan page
          });

          // Connect the camera stream to your video element
          video.srcObject = stream;
        } catch (error) {
          console.error("Camera error:", error);
          alert("Please allow camera access when prompted");
        }
      }

      // Start the camera when page loads
      startCamera();

      function stopCamera() {
        const stream = video.srcObject;
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
        }
      }

      startCamera();

      document
        .getElementById("backArrow")
        .addEventListener("click", function () {
          if (document.referrer && document.referrer !== "") {
            window.history.back();
          } else {
            window.location.href = "home.html";
          }
        });

      // =====================
      // Popup state
      // =====================
      let isEditing = false;

      function openSheet(id) {
        document.getElementById("backdrop").classList.add("active");
        document.getElementById(id).classList.add("open");
      }

      function closePopups() {
        document.getElementById("backdrop").classList.remove("active");
        document
          .querySelectorAll(".bottom-sheet")
          .forEach((s) => s.classList.remove("open"));
        setEditMode(false);
      }

      document
        .getElementById("backdrop")
        .addEventListener("click", closePopups);

      // Close on Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closePopups();
      });

      // =====================
      // Edit toggle
      // =====================
      function setEditMode(on) {
        isEditing = on;
        const inputs = document.querySelectorAll(
          "#food-popup .nutrient-row input",
        );
        inputs.forEach((input) => {
          if (on) {
            input.removeAttribute("readonly");
          } else {
            input.setAttribute("readonly", true);
          }
        });
        const btn = document.getElementById("edit-toggle-btn");
        btn.style.color = on ? "#E1FF00" : "#aaa";
      }

      function toggleEdit() {
        setEditMode(!isEditing);
        if (isEditing) {
          // focus first input
          document.getElementById("f-calorie").focus();
        }
      }

      // =====================
      // Food Popup API
      // Called by backend/scan logic:
      //   showFoodPopup({ name, calorie, protein, sugar, sodium, fat, fiber })
      // =====================
      function showFoodPopup(data) {
        document.getElementById("food-name").textContent =
          data.name || "Unknown Food";
        document.getElementById("f-calorie").value = data.calorie ?? 0;
        document.getElementById("f-protein").value = data.protein ?? 0;
        document.getElementById("f-sugar").value = data.sugar ?? 0;
        document.getElementById("f-sodium").value = data.sodium ?? 0;
        document.getElementById("f-fat").value = data.fat ?? 0;
        document.getElementById("f-fiber").value = data.fiber ?? 0;
        setEditMode(false);
        openSheet("food-popup");
      }

      // =====================
      // Barcode Popup API
      // Called by backend/scan logic:
      //   showBarcodePopup({ name, image })
      // =====================
      function showBarcodePopup(data) {
        document.getElementById("barcode-name").textContent =
          data.name || "Unknown Product";
        const img = document.getElementById("barcode-image");
        if (data.image) {
          img.src = data.image;
          img.style.display = "block";
        } else {
          img.style.display = "none";
        }
        openSheet("barcode-popup");
      }

      // =====================
      // Add handlers - backend hooks
      // Replace with actual API calls
      // =====================
      function addFoodEntry() {
        const entry = {
          name: document.getElementById("food-name").textContent,
          calorie: Number(document.getElementById("f-calorie").value),
          protein: Number(document.getElementById("f-protein").value),
          sugar: Number(document.getElementById("f-sugar").value),
          sodium: Number(document.getElementById("f-sodium").value),
          fat: Number(document.getElementById("f-fat").value),
          fiber: Number(document.getElementById("f-fiber").value),
        };
        console.log("[addFoodEntry]", entry);
        // TODO: send entry to backend
        closePopups();
      }

      function addBarcodeEntry() {
        const entry = {
          name: document.getElementById("barcode-name").textContent,
        };
        console.log("[addBarcodeEntry]", entry);
        // TODO: send entry to backend
        closePopups();
      }

      // =====================
      // Expose globally for backend integration
      // =====================
      window.showFoodPopup = showFoodPopup;
      window.showBarcodePopup = showBarcodePopup;
    </script>
  </body>
</html>

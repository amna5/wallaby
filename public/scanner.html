<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan</title>
    <link rel="stylesheet" href="inside.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  </head>
  <body>
    <div class="app">
      <div class="adjust">
        <div class="header">
          <img src="../img/arrow.svg" alt="arrow" id="backArrow" />
          <h1>Scan</h1>
        </div>
        <h3 class="scan-desc">scan barcode or food</h3>
        <div class="camera-container">
          <div id="camera-feed" style="width: 100%; overflow: hidden; border-radius: 12px;"></div>
        </div>
        <div class="floating-nav">
          <button class="nav-btn">
            <a href="home.html"
              ><img src="../img/home_button.svg" alt="Home"
            /></a>
          </button>

          <button class="nav-btn active">
            <a href="scanner.html"><img src="../img/scan.svg" alt="Scan" /></a>
          </button>

          <button class="nav-btn">
            <a href=""><img src="../img/people.svg" alt="Users" /></a>
          </button>
        </div>
      </div>
    </div>
    
    <div class="demo-controls">
      <button
        class="demo-btn"
        onclick="
          showFoodPopup({
            name: 'Roti Canai',
            calorie: 2000,
            protein: 5,
            sugar: 2,
            sodium: 2,
            fat: 5,
            fiber: 10,
          })
        "
      >
        Demo: Food Popup
      </button>
      <button
        class="demo-btn"
        onclick="
          showBarcodePopup({
            name: 'Heinz Beans 200g',
            image: '../img/beans.png',
          })
        "
      >
        Demo: Barcode Popup
      </button>
    </div>

    <div class="overlay-backdrop" id="backdrop"></div>

    <div
      class="bottom-sheet"
      id="food-popup"
      role="dialog"
      aria-modal="true"
      aria-label="Food details"
    >
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <h2 id="food-name">Food Name</h2>
        <button
          class="edit-btn"
          id="edit-toggle-btn"
          title="Edit nutrients"
          onclick="toggleEdit()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
            />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>
      </div>

      <div 
        id="ai-verdict-box" 
        style="display: none; background: rgba(255, 60, 60, 0.15); border-left: 4px solid #ff3c3c; padding: 12px; margin: 10px 20px; border-radius: 8px; font-size: 0.85em; color: #fff; line-height: 1.4;"
      >
        <strong style="color: #ff3c3c; display: block; margin-bottom: 4px;">ü§ñ BiteWise AI Analysis:</strong> 
        <span id="ai-verdict-text">Analyzing ingredients...</span>
      </div>

      <div class="nutrient-list">
        <div class="nutrient-row">
          <label>calorie</label>
          <input type="number" id="f-calorie" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>protein(g)</label>
          <input type="number" id="f-protein" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>sugar(g)</label>
          <input type="number" id="f-sugar" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>sodium(g)</label>
          <input type="number" id="f-sodium" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>fat(g)</label>
          <input type="number" id="f-fat" value="0" readonly />
        </div>
        <div class="nutrient-row">
          <label>fiber(g)</label>
          <input type="number" id="f-fiber" value="0" readonly />
        </div>
      </div>

      <div class="sheet-actions">
        <button class="sheet-btn btn-cancel" onclick="closePopups()">
          Cancel
        </button>
        <button class="sheet-btn btn-add" onclick="addFoodEntry()">Add</button>
      </div>
    </div>

    <div
      class="bottom-sheet"
      id="barcode-popup"
      role="dialog"
      aria-modal="true"
      aria-label="Product details"
    >
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <h2 id="barcode-name">Product Name</h2>
      </div>

      <div style="padding-bottom: 80px" class="product-image-wrap">
        <img id="barcode-image" src="" alt="Product image" />
      </div>

      <div class="sheet-actions">
        <button class="sheet-btn btn-cancel" onclick="closePopups()">
          Cancel
        </button>
        <button class="sheet-btn btn-add" onclick="addBarcodeEntry()">
          Add
        </button>
      </div>
    </div>

<script>
// API KEY HERE 
const GEMINI_API_KEY = "AIzaSyBDAqGzh2z8tKyaAgbmE9GSZ-qIt9CYfr4";

// 1. Initialize the Barcode Scanner
const html5QrCode = new Html5Qrcode("camera-feed");

// 2. Start the camera and look for barcodes
function startSmartScanner() {
  html5QrCode.start(
    { facingMode: "environment" }, // Forces the back camera
    {
      fps: 10, // Scans 10 times per second
      qrbox: { width: 250, height: 150 } // Draws a scanning box
    },
    (decodedText, decodedResult) => {
      // SUCCESS! A barcode was found.
      console.log(`Scanned Barcode: ${decodedText}`);
      
      // Pause the scanner so it doesn't scan 100 times
      html5QrCode.pause(); 
      
      // Send the barcode to our API function
      fetchFoodData(decodedText);
    },
    (errorMessage) => {
      // It will throw errors constantly while looking for a barcode. We ignore this.
    }
  ).catch((err) => {
    console.error("Camera failed to start", err);
    alert("Please allow camera access!");
  });
}

// 3. Fetch data from Open Food Facts API
async function fetchFoodData(barcode) {
  try {
    // Let the user know it's loading (optional, but good UX)
    document.getElementById("food-name").textContent = "Loading...";
    openSheet("food-popup");

    // Call the free Open Food Facts API
    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
    const data = await response.json();

    if (data.status === 1) {
      // The product exists! Grab the data
      const product = data.product;
      const nutriments = product.nutriments || {};

      document.getElementById("ai-verdict-box").style.display = "none";

      // Send the real data into your existing popup!
      showFoodPopup({
        name: product.product_name || "Unknown Product",
        calorie: nutriments['energy-kcal_100g'] || 0,
        protein: nutriments.proteins_100g || 0,
        sugar: nutriments.sugars_100g || 0,
        sodium: nutriments.sodium_100g || 0, 
        fat: nutriments.fat_100g || 0,
        fiber: nutriments.fiber_100g || 0
      });

      // Grab ingredients, but default to a specific phrase if missing
      window.currentIngredients = product.ingredients_text || "Not found in database";
      console.log("Ingredients for Gemini:", window.currentIngredients);
      
      // ALWAYS trigger the AI analysis, even if ingredients are missing!
      analyzeIngredientsWithAI(product.product_name, window.currentIngredients);

    } else {
      alert("Product not found in database!");
      closePopups();
      html5QrCode.resume(); // Start scanning again
    }
  } catch (error) {
    console.error("Error fetching data:", error);
    alert("Network error. Please try again.");
    html5QrCode.resume();
  }
}

// Start the scanner when the page loads
startSmartScanner();

document.getElementById("backArrow").addEventListener("click", function () {
  if (document.referrer && document.referrer !== "") {
    window.history.back();
  } else {
    window.location.href = "home.html";
  }
});

// =====================
// Popup state
// =====================
let isEditing = false;

function openSheet(id) {
  document.getElementById("backdrop").classList.add("active");
  document.getElementById(id).classList.add("open");
}

function closePopups() {
  document.getElementById("backdrop").classList.remove("active");
  document.querySelectorAll(".bottom-sheet").forEach((s) => s.classList.remove("open"));
  setEditMode(false);
  
  // Resume scanner if closed!
  if (typeof html5QrCode !== 'undefined' && html5QrCode.getState() === Html5QrcodeScannerState.PAUSED) {
     html5QrCode.resume();
  }
}

document.getElementById("backdrop").addEventListener("click", closePopups);
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closePopups();
});

// =====================
// Edit toggle
// =====================
function setEditMode(on) {
  isEditing = on;
  const inputs = document.querySelectorAll("#food-popup .nutrient-row input");
  inputs.forEach((input) => {
    if (on) {
      input.removeAttribute("readonly");
    } else {
      input.setAttribute("readonly", true);
    }
  });
  const btn = document.getElementById("edit-toggle-btn");
  btn.style.color = on ? "#E1FF00" : "#aaa";
}

function toggleEdit() {
  setEditMode(!isEditing);
  if (isEditing) {
    document.getElementById("f-calorie").focus();
  }
}

// =====================
// Food Popup API
// =====================
function showFoodPopup(data) {
  document.getElementById("food-name").textContent = data.name || "Unknown Food";
  document.getElementById("f-calorie").value = data.calorie ?? 0;
  document.getElementById("f-protein").value = data.protein ?? 0;
  document.getElementById("f-sugar").value = data.sugar ?? 0;
  document.getElementById("f-sodium").value = data.sodium ?? 0;
  document.getElementById("f-fat").value = data.fat ?? 0;
  document.getElementById("f-fiber").value = data.fiber ?? 0;
  setEditMode(false);
  openSheet("food-popup");
}

function showBarcodePopup(data) {
  document.getElementById("barcode-name").textContent = data.name || "Unknown Product";
  const img = document.getElementById("barcode-image");
  if (data.image) {
    img.src = data.image;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }
  openSheet("barcode-popup");
}

// =====================
// Add handlers
// =====================
function addFoodEntry() {
  const entry = {
    name: document.getElementById("food-name").textContent,
    calorie: Number(document.getElementById("f-calorie").value),
    protein: Number(document.getElementById("f-protein").value),
    sugar: Number(document.getElementById("f-sugar").value),
    sodium: Number(document.getElementById("f-sodium").value),
    fat: Number(document.getElementById("f-fat").value),
    fiber: Number(document.getElementById("f-fiber").value),
    timestamp: new Date().toISOString()
  };

  let currentPantry = JSON.parse(localStorage.getItem("myFoodPantry")) || [];
  currentPantry.push(entry);
  localStorage.setItem("myFoodPantry", JSON.stringify(currentPantry));

  alert(`‚úÖ Successfully added ${entry.name} to your pantry!`);
  closePopups();
}

function addBarcodeEntry() {
  const entry = {
    name: document.getElementById("barcode-name").textContent,
  };
  console.log("[addBarcodeEntry]", entry);
  closePopups();
}

window.showFoodPopup = showFoodPopup;
window.showBarcodePopup = showBarcodePopup;

// =====================
// THE GEMINI BRAIN
// =====================
async function analyzeIngredientsWithAI(foodName, ingredients) {
  const userProfile = {
    condition: "Type 2 Diabetes",
    allergy: "Peanuts",
    preference: "Halal"
  };

  const promptText = `
    You are an expert nutritionist. 
    Analyze this food: ${foodName}.
    Ingredients: ${ingredients}.
    User Profile: Has ${userProfile.condition}, allergic to ${userProfile.allergy}, prefers ${userProfile.preference}.
    
    Task: 
    1. Are there any hidden sugars or ingredients bad for their condition?
    2. Are there any allergy warnings?
    Keep the response very short, maximum 2 bullet points.
  `;

  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  try {
    const verdictBox = document.getElementById("ai-verdict-box");
    const verdictText = document.getElementById("ai-verdict-text");
    
    verdictBox.style.display = "block";
    verdictBox.style.borderLeftColor = "#E1FF00"; 
    verdictBox.style.background = "rgba(225, 255, 0, 0.1)";
    verdictText.innerHTML = "<em>Analyzing ingredients for your profile...</em>";
    
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: promptText }] }]
      })
    });

    const data = await response.json();
    
    // NEW: We check if Google sent back an error!
    if (!response.ok) {
      console.error("Detailed Google Error:", data);
      throw new Error(data.error?.message || "Google API rejected the request.");
    }

    // If it's successful, grab the text
    const aiVerdict = data.candidates[0].content.parts[0].text;
    
    verdictBox.style.borderLeftColor = "#ff3c3c"; 
    verdictBox.style.background = "rgba(255, 60, 60, 0.15)";
    verdictText.innerHTML = aiVerdict.replace(/\n/g, "<br>");

  } catch (error) {
    // This safely catches the error without crashing the rest of your app!
    console.error("Gemini AI Error:", error.message);
    const verdictText = document.getElementById("ai-verdict-text");
    verdictText.innerHTML = `‚ö†Ô∏è API Error: ${error.message}`;
    
    const verdictBox = document.getElementById("ai-verdict-box");
    verdictBox.style.borderLeftColor = "#ffaa00"; // Orange error color
  }
}
</script>
</body>
</html>